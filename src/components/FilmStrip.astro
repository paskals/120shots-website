---
const { images } = Astro.props;
---

<div
  class="film-strip md:h-64 sm:h-56 xs:h-52 overflow-x-auto overflow-y-hidden"
>
  <div
    class="film-scroll-container h-full m-0 px-2 py-8 w-max flex justify-center align-middle"
  >
    {
      images.map((image) =>
        image ? (
          <div class="film-frame my-2 mx-1">
            <a
              href={image.src}
              class="glightbox block"
              data-astro-prefetch="false"
            >
              <img
                src={image.src}
                alt={image.alt}
                loading="lazy"
                decoding="async"
                class="film-image md:h-44 sm:h-36 h-32 w-auto"
                data-film-image
              />
            </a>
          </div>
        ) : null,
      )
    }
  </div>
</div>

<style>
  .film-frame {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .film-frame.portrait .film-image {
    transform: rotate(90deg);
    /* Override height constraint, use width constraint instead */
    height: auto !important;
    max-height: none !important;
  }

  .film-scroll-container {
    --background: #393939;
    align-items: center;
    --size: 1rem;
    background-image: linear-gradient(
        to right,
        var(--background) calc(var(--size) * 1.4),
        transparent var(--size)
      ),
      linear-gradient(
        to bottom,
        var(--background) calc(var(--size) * 1),
        transparent var(--size)
      ),
      linear-gradient(
        to right,
        var(--background) calc(var(--size) * 1.4),
        transparent var(--size)
      ),
      linear-gradient(
        to bottom,
        var(--background) calc(var(--size) * 1),
        transparent var(--size)
      ),
      linear-gradient(
        to bottom,
        transparent calc(var(--size) * 1),
        var(--background) var(--size)
      );
    background-size:
      calc(var(--size) * 2) var(--size),
      calc(var(--size) * 2) var(--size),
      calc(var(--size) * 2) var(--size),
      calc(var(--size) * 2) var(--size),
      100% calc(100% - var(--size) * 3);
    background-repeat: repeat-x;
    background-position:
      0 var(--size),
      top left,
      0 calc(100% - var(--size)),
      bottom left,
      0 var(--size);
    box-sizing: border-box;
  }
</style>

<script src="../scripts/lightbox.js"></script>

<script>
  function handleFilmImage(img: HTMLImageElement) {
    const applyRotation = () => {
      const { naturalWidth, naturalHeight, offsetHeight } = img;
      if (!naturalWidth || !naturalHeight) return;

      // Check if portrait
      if (naturalHeight > naturalWidth) {
        const frame = img.closest(".film-frame") as HTMLElement;
        if (!frame) return;

        // For portrait images, we want the rotated visual height to match
        // landscape image heights. So set image width = current offsetHeight
        // (what landscape images use for height), then height scales by aspect ratio.
        const targetWidth = offsetHeight; // e.g., 176px
        const aspectRatio = naturalHeight / naturalWidth;
        const targetHeight = targetWidth * aspectRatio;

        // Set image dimensions: width fixed, height by aspect ratio
        img.style.width = `${targetWidth}px`;
        img.style.height = `${targetHeight}px`;

        // Frame width = rotated visual width = image height
        // Frame height = rotated visual height = image width (same as landscape img height)
        frame.style.width = `${targetHeight}px`;
        frame.style.height = `${targetWidth}px`;
        frame.classList.add("portrait");
      }
    };

    if (img.complete && img.naturalWidth) {
      requestAnimationFrame(applyRotation);
    } else {
      img.addEventListener("load", () => requestAnimationFrame(applyRotation));
    }
  }

  document
    .querySelectorAll<HTMLImageElement>("[data-film-image]")
    .forEach(handleFilmImage);
</script>
