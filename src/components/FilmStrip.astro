---
const { images, format = "35mm" } = Astro.props;
const mediumFormats = ["645", "6x6", "6x7", "6x8", "6x9"];
const isMediumFormat = mediumFormats.includes(format);
---

<div
  class:list={[
    "film-strip overflow-x-auto overflow-y-hidden",
    isMediumFormat
      ? "md:h-[460px] sm:h-[400px] h-[360px]"
      : "md:h-64 sm:h-56 xs:h-52",
  ]}
  data-format={format}
>
  <div
    class:list={[
      "h-full m-0 px-2 w-max flex justify-center align-middle",
      isMediumFormat
        ? "film-scroll-container-medium py-3"
        : "film-scroll-container py-8",
    ]}
  >
    {
      images.map((image) =>
        image ? (
          <div class="film-frame my-2 mx-1">
            <a
              class="block"
              data-astro-prefetch="false"
            >
              <img
                src={image.src}
                alt={image.alt}
                loading="lazy"
                decoding="async"
                class:list={[
                  "film-image w-auto",
                  isMediumFormat
                    ? "md:h-[420px] sm:h-[370px] h-[330px]"
                    : "md:h-44 sm:h-36 h-32",
                ]}
                data-film-image
              />
            </a>
          </div>
        ) : null,
      )
    }
  </div>
</div>

<style>
  .film-frame {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .film-frame.portrait .film-image,
  .film-frame.landscape-rotated .film-image {
    transform: rotate(90deg);
    height: auto !important;
    max-height: none !important;
  }

  .film-scroll-container {
    --background: #393939;
    align-items: center;
    --size: 1rem;
    background-image:
      linear-gradient(
        to right,
        var(--background) calc(var(--size) * 1.4),
        transparent var(--size)
      ),
      linear-gradient(
        to bottom,
        var(--background) calc(var(--size) * 1),
        transparent var(--size)
      ),
      linear-gradient(
        to right,
        var(--background) calc(var(--size) * 1.4),
        transparent var(--size)
      ),
      linear-gradient(
        to bottom,
        var(--background) calc(var(--size) * 1),
        transparent var(--size)
      ),
      linear-gradient(
        to bottom,
        transparent calc(var(--size) * 1),
        var(--background) var(--size)
      );
    background-size:
      calc(var(--size) * 2) var(--size),
      calc(var(--size) * 2) var(--size),
      calc(var(--size) * 2) var(--size),
      calc(var(--size) * 2) var(--size),
      100% calc(100% - var(--size) * 3);
    background-repeat: repeat-x;
    background-position:
      0 var(--size),
      top left,
      0 calc(100% - var(--size)),
      bottom left,
      0 var(--size);
    box-sizing: border-box;
  }

  .film-scroll-container-medium {
    --background: #393939;
    align-items: center;
    background-color: var(--background);
  }
</style>

<script>
  function handleFilmStrips() {
    document.querySelectorAll<HTMLElement>(".film-strip").forEach((strip) => {
      const format = strip.dataset.format || "35mm";
      const is645 = format === "645";
      const mediumFormats = ["645", "6x6", "6x7", "6x8", "6x9"];
      const isMedium = mediumFormats.includes(format);

      strip
        .querySelectorAll<HTMLImageElement>("[data-film-image]")
        .forEach((img) => {
          const applyRotation = () => {
            const { naturalWidth, naturalHeight, offsetHeight } = img;
            if (!naturalWidth || !naturalHeight) return;

            const isPortrait = naturalHeight > naturalWidth * 1.05;
            const isLandscape = naturalWidth > naturalHeight * 1.05;

            if (is645 && isLandscape) {
              // 645: rotate landscape images to portrait
              const frame = img.closest(".film-frame") as HTMLElement;
              if (!frame) return;

              const targetWidth = offsetHeight;
              const aspectRatio = naturalHeight / naturalWidth;
              const targetHeight = targetWidth * aspectRatio;

              img.style.width = `${targetWidth}px`;
              img.style.height = `${targetHeight}px`;

              frame.style.width = `${targetHeight}px`;
              frame.style.height = `${targetWidth}px`;
              frame.classList.add("landscape-rotated");
            } else if (!isMedium && isPortrait) {
              // 35mm/half-frame/4x5: rotate portrait images to landscape
              const frame = img.closest(".film-frame") as HTMLElement;
              if (!frame) return;

              const targetWidth = offsetHeight;
              const aspectRatio = naturalHeight / naturalWidth;
              const targetHeight = targetWidth * aspectRatio;

              img.style.width = `${targetWidth}px`;
              img.style.height = `${targetHeight}px`;

              frame.style.width = `${targetHeight}px`;
              frame.style.height = `${targetWidth}px`;
              frame.classList.add("portrait");
            }
            // Medium formats (non-645): no rotation needed
          };

          if (img.complete && img.naturalWidth) {
            requestAnimationFrame(applyRotation);
          } else {
            img.addEventListener("load", () =>
              requestAnimationFrame(applyRotation),
            );
          }
        });
    });
  }

  document.addEventListener("astro:page-load", handleFilmStrips);
</script>
