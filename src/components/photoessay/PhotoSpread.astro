---
import { Image } from "astro:assets";

interface Photo {
  src: string;
  alt: string;
  fit?: "cover" | "contain";
}

interface Props {
  layout: "single" | "duo" | "duo-h" | "duo-l" | "duo-r" | "trio" | "trio-l" | "trio-r";
  photos: Photo[];
  caption?: string;
  index: number;
}

const { layout, photos, caption, index } = Astro.props;

// Validate photo count for layout
const expectedPhotos: Record<string, number> = {
  single: 1,
  duo: 2,
  "duo-h": 2,
  "duo-l": 2,
  "duo-r": 2,
  trio: 3,
  "trio-l": 3,
  "trio-r": 3,
};
const photoCount = Math.min(photos.length, expectedPhotos[layout]);
const displayPhotos = photos.slice(0, photoCount);

// For trio-l and trio-r, we need to separate photos into stack and main
// trio-l: photos 1,2 stacked on left, photo 3 main on right
// trio-r: photo 1 main on left, photos 2,3 stacked on right
const isTrioVariant = layout === "trio-l" || layout === "trio-r";
const stackPhotos = isTrioVariant
  ? layout === "trio-r"
    ? displayPhotos.slice(0, 2)
    : displayPhotos.slice(1, 3)
  : [];
const mainPhoto = isTrioVariant
  ? layout === "trio-r"
    ? displayPhotos[2]
    : displayPhotos[0]
  : null;

// For duo-l and duo-r, we emphasize one side with wider width
// duo-l: left photo is emphasized (wider)
// duo-r: right photo is emphasized (wider)
const isDuoVariant = layout === "duo-l" || layout === "duo-r";
const leftPhoto = isDuoVariant ? displayPhotos[0] : null;
const rightPhoto = isDuoVariant ? displayPhotos[1] : null;
---

<section class="spread" data-layout={layout} data-index={index} data-has-caption={caption ? "true" : undefined}>
  {
    isTrioVariant ? (
      <div class="spread-photos">
        {layout === "trio-r" && (
          <>
            <div class="photo-stack">
              {stackPhotos.map((photo) => (
                <div class="photo-wrapper">
                  <Image
                    src={photo.src}
                    alt={photo.alt}
                    inferSize
                    loading={index === 0 ? "eager" : "lazy"}
                    decoding={index === 0 ? "sync" : "async"}
                  />
                </div>
              ))}
            </div>
            {mainPhoto && (
              <div class="photo-wrapper photo-main">
                <Image
                  src={mainPhoto.src}
                  alt={mainPhoto.alt}
                  inferSize
                  loading={index === 0 ? "eager" : "lazy"}
                  decoding={index === 0 ? "sync" : "async"}
                />
              </div>
            )}
          </>
        )}
        {layout === "trio-l" && (
          <>
            {mainPhoto && (
              <div class="photo-wrapper photo-main">
                <Image
                  src={mainPhoto.src}
                  alt={mainPhoto.alt}
                  inferSize
                  loading={index === 0 ? "eager" : "lazy"}
                  decoding={index === 0 ? "sync" : "async"}
                />
              </div>
            )}
            <div class="photo-stack">
              {stackPhotos.map((photo) => (
                <div class="photo-wrapper">
                  <Image
                    src={photo.src}
                    alt={photo.alt}
                    inferSize
                    loading={index === 0 ? "eager" : "lazy"}
                    decoding={index === 0 ? "sync" : "async"}
                  />
                </div>
              ))}
            </div>
          </>
        )}
      </div>
    ) : isDuoVariant ? (
      <div class="spread-photos">
        {leftPhoto && (
          <div class={`photo-wrapper ${layout === "duo-l" ? "photo-emphasized" : ""}`}>
            <Image
              src={leftPhoto.src}
              alt={leftPhoto.alt}
              inferSize
              loading={index === 0 ? "eager" : "lazy"}
              decoding={index === 0 ? "sync" : "async"}
            />
          </div>
        )}
        {rightPhoto && (
          <div class={`photo-wrapper ${layout === "duo-r" ? "photo-emphasized" : ""}`}>
            <Image
              src={rightPhoto.src}
              alt={rightPhoto.alt}
              inferSize
              loading={index === 0 ? "eager" : "lazy"}
              decoding={index === 0 ? "sync" : "async"}
            />
          </div>
        )}
      </div>
    ) : (
      <div class="spread-photos">
        {displayPhotos.map((photo) => (
          <div class="photo-wrapper">
            <Image
              src={photo.src}
              alt={photo.alt}
              inferSize
              loading={index === 0 ? "eager" : "lazy"}
              decoding={index === 0 ? "sync" : "async"}
            />
          </div>
        ))}
      </div>
    )
  }
  {caption && <p class="spread-caption">{caption}</p>}
</section>
