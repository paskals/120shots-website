---
import { ViewTransitions } from "astro:transitions";
import { Image } from "astro:assets";
import ThemeIcon from "../components/ThemeIcon.astro";
import "@fontsource-variable/overpass-mono";
import "@fontsource-variable/inconsolata";
import { getImage } from "astro:assets";
import "../styles/global.css";
import "../styles/photoessay.css";

interface Props {
  title: string;
  description: string;
  image?: string;
  pubDate?: Date;
  updatedDate?: Date;
  spreadCount: number;
}

const { title, description, image, pubDate, updatedDate, spreadCount } =
  Astro.props;

const baseUrl = new URL(Astro.request.url).origin;
const siteName = "120 Shots";
const pageTitle = title.concat(" â€º ", siteName);

const favicon = {
  src: "/120Shots_icon_nobackground.png",
  alt: "favicon",
  width: "512",
  height: "512",
};
---

<html class="" lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/webp" href="/120Shots_icon_background.png" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="og:title" content={pageTitle} />
    <meta name="og:description" content={description} />
    <meta name="description" content={description} />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content={siteName} />
    {image && <meta name="og:image" content={image} />}
    <meta name="article:published_time" content={pubDate?.toISOString()} />
    {updatedDate && <meta name="article:modified_time" content={updatedDate.toISOString()} />}
    <meta name="og:url" content={Astro.url} />
    <meta name="twitter:card" content="summary_large_image" />
    <title>{pageTitle}</title>
    <ViewTransitions />
  </head>
  <body class="essay-body">
    <!-- Minimal header -->
    <header class="essay-header">
      <nav class="essay-nav">
        <div class="essay-nav-left">
          <a href="/essays" class="essay-back" aria-label="Back to essays">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </a>
          <a href="/" class="essay-logo" aria-label="Home">
            <Image
              src="/120Shots_icon_nobackground.png"
              alt="120 Shots"
              width={32}
              height={32}
              class="dark:invert"
            />
          </a>
        </div>
        <span class="essay-title-header">{title}</span>
        <div class="essay-header-actions">
          <ThemeIcon />
        </div>
      </nav>
    </header>

    <!-- Main essay container with scroll snap -->
    <main class="essay-container" id="essay-container" data-spread-count={spreadCount}>
      <slot />
    </main>

    <!-- Progress indicator -->
    <div class="essay-progress" id="essay-progress" aria-label="Spread progress">
      <svg class="progress-ring" viewBox="0 0 36 36">
        <circle
          class="progress-ring-bg"
          cx="18"
          cy="18"
          r="16"
          fill="none"
          stroke-width="2"
        />
        <circle
          class="progress-ring-fill"
          cx="18"
          cy="18"
          r="16"
          fill="none"
          stroke-width="2"
          stroke-dasharray="100.53"
          stroke-dashoffset="100.53"
        />
      </svg>
      <span class="progress-text">
        <span class="progress-current">1</span>
        <span class="progress-separator">/</span>
        <span class="progress-total">{spreadCount}</span>
      </span>
    </div>

    <script>
      function initEssayNav() {
        const container = document.getElementById("essay-container");
        const spreads = document.querySelectorAll(".spread");
        const progressRing = document.querySelector(".progress-ring-fill") as SVGCircleElement;
        const progressCurrent = document.querySelector(".progress-current");

        if (!container || !spreads.length) return;

        const totalSpreads = spreads.length;
        const circumference = 2 * Math.PI * 16; // r=16
        let currentIndex = 0;

        // Update progress indicator
        function updateProgress(index: number) {
          currentIndex = index;
          const progress = (index + 1) / totalSpreads;
          const offset = circumference * (1 - progress);

          if (progressRing) {
            progressRing.style.strokeDashoffset = String(offset);
          }
          if (progressCurrent) {
            progressCurrent.textContent = String(index + 1);
          }
        }

        // Observe spreads for scroll position
        const observerOptions = {
          root: container,
          threshold: 0.5,
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const index = Array.from(spreads).indexOf(entry.target as Element);
              updateProgress(index);
            }
          });
        }, observerOptions);

        spreads.forEach((spread) => observer.observe(spread));

        // Keyboard navigation
        document.addEventListener("keydown", (e) => {
          if (e.key === "ArrowDown" || e.key === "j") {
            e.preventDefault();
            const nextIndex = Math.min(currentIndex + 1, spreads.length - 1);
            spreads[nextIndex]?.scrollIntoView({ behavior: "smooth" });
          } else if (e.key === "ArrowUp" || e.key === "k") {
            e.preventDefault();
            const prevIndex = Math.max(currentIndex - 1, 0);
            spreads[prevIndex]?.scrollIntoView({ behavior: "smooth" });
          }
        });

        // Click on progress to go to next spread
        const progressEl = document.getElementById("essay-progress");
        if (progressEl) {
          progressEl.addEventListener("click", () => {
            const nextIndex = (currentIndex + 1) % totalSpreads;
            spreads[nextIndex]?.scrollIntoView({ behavior: "smooth" });
          });
        }

        // Initialize first spread
        updateProgress(0);
      }

      // Initialize on page load and after view transitions
      document.addEventListener("astro:page-load", initEssayNav);
    </script>
  </body>
</html>
